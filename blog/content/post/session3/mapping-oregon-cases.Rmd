---
title: "Mapping COVID-19 Cases in Oregon"
author: "Zach"
date: "2020-04-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Session Overview

This week, Kelsey spent some time mapping the COVID-19 cases in Oregon and generated some plots for 
us.  She already has provided some most illustrative documentation for her code, so I will simply 
attempt to augment what she has already done.

In this post, we will be covering the following subjects:

* Subsetting the full dataset to obtain only the Oregon cases
* Dividing the Oregon data into 10-day intervals for analysis
* Generating a 2-dimensional density plot (heatmap) of the confirmed cases in Oregon


As always, if you'd like to download the code and run it yourself, [**check it out on github**](https://github.com/H4estu/COVID19-Data-Exploration/blob/master/scripts/R/session3/covid_heat_map.R).
I have edited out a few things in this post for clarity, so again, check out the link above to see
the script in its full glory.  There is much to unpack in this script, and I would highly recommend
that you run it yourself line-by-line to see what each command outputs.  Please do not hesistate to 
reach out to me if you have questions on any of this! :)

***

## Setting Up the Environment

First of all, we need to set up the environment in which we will be conducting our computations and 
analysis.  This includes importing the appropriate libraries and connecting to the database to pull 
in the COVID-19 data.  I have moved the code that connects to the database to a separate file and 
wrapped it in a function call so that sensitive information such as the database username and 
password are protected.  Contact me if you need help setting up your own database configuration
script.  Finally, recall that if you want to run this code, *you must be connected to the VPN*, as 
the database lives on Kyle's work machine and is only accessible via the office network.
```{r initialize, results='hide'}
library(data.table)
library(magrittr)
library(dplyr)
library(ggplot2)
library(stringr)
library(RPostgreSQL)
library(maps)
library(RColorBrewer)
library(gridExtra)


git.path <- Sys.getenv('HOME')  # Where the base COVID19-Data-Exploration folder lives.

# -------- Access the COVID-19 Database --------- #
source(file.path(git.path,'Code/config_files/db_config.R'))
con <- db_connect.fn()
full.dt<-dbGetQuery(con,'SELECT * FROM covid_data.report_data') %>% data.table
dbDisconnect(con)  
# ----------------------------------------------- #

```
***

## Subsetting the data
To orient ourselves to the data, let's first look at the number of cases in Oregon.  Here we
are just looking at data since 01 March, because the data seem more consistently documented (in terms
of how they are encoded in the database) since that date.

```{r first-look}
### Summary of Oregon cases using the same method that Zach presented in the first class ###
oregon_cases.dt <- full.dt[which((grepl(', OR', full.dt$province_state) | 
                                    full.dt$province_state =='Oregon'
                                  ) & !is.na(full.dt$latitude)
                                 ), ] %>%
  group_by(last_update) %>%
  summarize(Recovered=max(recovered), 
            Deaths=max(deaths), 
            Confirmed=max(confirmed), 
            Active=max(active)
  ) %>% data.table

melted.dt <- melt(oregon_cases.dt, id.vars='last_update', variable.name = 'Cases', 
                  value.name='Number.Reported')
ggplot(melted.dt, aes(x=last_update, y=Number.Reported, color=Cases)) +
  geom_point() + 
  geom_line()
```

What are some interesting trends that you see?  Personally I find it interesting that no one appears
to be reporting `recovered` cases (pink line).  Perhaps they are trying to capture that metric by 
reporting the number of `active` cases (purple line)?  


Now that we've re-acquainted ourselves with the general temporal trend of the data, we still need to
massage the dataset a bit more to prepare it to be plotted on a heatmap.  Kelsey describes what she
is doing in the comments, so you can follow along there.  She takes you through the process of 
exploring the dataset to see what needs to be manipulated, as well as the process of actually
manipulating it.  I'll provide a brief summary of what is done at each step as well.

First, let's seach through the `province_state` column for strings of letters that will return **Oregon** 
data.  Since the data were collected at the county level in the initial phase of the project, we 
need to search for tags like **OR** and **Oregon** to find all records reported in the state.

```{r examine-data}
### Subset data down to only Oregon data ###
# Look at the last 6 unique values for Oregon province_state; we had a change in reporting so we 
# are going to only use the data from the update onwards.
full.dt[which((grepl(', OR', full.dt$province_state) | full.dt$province_state =='Oregon') &
                      !is.na(full.dt$latitude)
                    ), ]$province_state %>% unique %>% tail
```

Something to note here is that in late March, the maintainters of this dataset changed the way they 
encoded U.S data.  Prior to this date, both the county and state names were included in the `province_state`
column.  The updated convention is to include only the name of the state in the `province_state` and
move the county name to `admin2`.  This makes querying the data much easier, and so we are only using
the records that adhere to this convention.

```{r}
covid.OR<-full.dt[which(full.dt$province_state =='Oregon' &  !is.na(full.dt$latitude) & 
                          !is.na(full.dt$admin2)
                        ), ]
```

## Examine Change Over Time
Now that we've filtered the dataset to just the Oregon cases, we will split them by date (`last_update`)
and group them into 10-day intervals for plotting.  As Kelsey mentioned in the session, 7-day (1-week)
intervals would have worked just as well.  The length of the interval we choose isn't terribly important --
it is just a means by which to aggregate the data into bins so that we may look at change over time.  
This interval does not currently exist in the dataset, so we must create it ourselves.  Here we've 
given it the name `period` to denote the *period of time* over which we will look at change.

```{r format-dates}
# Look at the data split by date to determine how to work with it #
covid.OR %>% split(.,.$last_update) %>% .[c(1,2)] %>% lapply(., head)

# Add new fields and make the date pretty for plotting
covid.OR$month<-covid.OR$last_update %>% format(., "%B")

# Separate each month into 'periods' for analysis over time. (I don't know why I didn't do weeks lol)
covid.OR$period<-"NA"
covid.OR[covid.OR$last_update %>% format(., "%d") %in% paste0('0',1:9),]$period<-paste0(
  covid.OR[covid.OR$last_update %>% format(., "%d") %in% paste0('0',1:9),]$month,' 1-9')
covid.OR[covid.OR$last_update %>% format(., "%d") %in% 10:19,]$period<-paste0(
  covid.OR[covid.OR$last_update %>% format(., "%d") %in% 10:19,]$month,' 10-19')
covid.OR[covid.OR$last_update %>% format(., "%d") %in% 20:31,]$period<-paste0(
  covid.OR[covid.OR$last_update %>% format(., "%d") %in% 20:31,]$month,' 20-31')

# Create factor levels for ggplot facet wrap
covid.OR$period<-covid.OR$period %>% factor(levels = unique(.))
```

## Plotting the Data
Next, we filter the dataset further to include only the columns we need to generate a mapped product.
We need the variable of interest to plot, in this case the number of COVID-19-related deaths in Oregon,
so we will keep the `deaths` column.  Since we are creating a map, we of course need geographic coordinates, 
and so will keep the `latitude` and `longitude` columns.  Finally, we need the temporal period over which
we will bin the data, so we must keep the `period` column.

```{r subset-deaths}
# Look at only deaths firsts, so subset out only that data
subset<-covid.OR[,c('deaths','latitude', 'longitude', 'period')]

# The function we will be using to create our heat map requires that each value be a unique 'event' 
# with its own coordinate location rather than being able to weight the points by a particular value. 
# Because of this we must replicate our rows and their lat/long data by the number of the parameter 
# of interest.
subset.expanded <- subset[rep(1:nrow(subset), subset$deaths)]
# Check out the results
tail(subset.expanded, 20)

# Next we are going to summarize our data for the point based heat map that we are going to do.
subset.summary<- subset[,.(deaths=max(deaths)), by=c('period','latitude', 'longitude')]
print(subset.summary)
```

That was a lot of work, but now we are finally ready to make our map!  We will use the `maps` package
to generate a nice Oregon-shaped polygon and then use our old friend `ggplot2` to plot create point
and heat maps of the dataset.

```{r map-deaths}
# Generate a map of Oregon to plot the COVID data on using 'maps' package
all_states<-map_data('state')

Oregon<-all_states[all_states$region=='oregon',]
p <- ggplot() +
  geom_polygon(data=Oregon, aes(x=long, y=lat))
print(p)

## Plot a heat map layer: Polygons with fill colors based on
## relative frequency of events
COVID.map <- p + stat_density2d(data=subset.expanded, aes(x=longitude, y=latitude, fill=..level.., 
                                                          alpha=..level..), geom="polygon")
print(COVID.map)

# Remove legends and add title
# Define the spectral colors to fill the density contours using the 'RColorBrewer' package
display.brewer.all(n=NULL, type="all", select=NULL, exact.n=TRUE,
                   colorblindFriendly=FALSE)
COVID.map <- COVID.map + theme(legend.position = 'none') +
  ggtitle("Oregon Covid-19 Deaths: Heat Map") +
  scale_fill_gradientn(colours=brewer.pal(7, "Reds"))
print(COVID.map)

## Plot Covid-19 by the period that we created earlier
COVID.heat.map <- COVID.map + facet_wrap(~period)
# print(COVID.heat.map)

# Create new map with geom_point layer that uses the max deaths by location and period to dictate  
# size (heat map with no interpolation + represents all values)
COVID.point.map <- p + geom_point(data=subset.summary, aes(x=longitude, y=latitude, size=deaths, 
                                                           color=deaths), alpha = 0.7) +
  ggtitle("Oregon Covid-19 Deaths: Point") +
  scale_color_gradientn(colours=brewer.pal(7, "Reds")) + 
  facet_wrap(~period)
print(COVID.point.map)

# Plot both maps next to each other and compare using the gridExtra package
# deaths <-grid.arrange(COVID.heat.map, COVID.point.map, ncol = 2)
```

Here are both maps plotted together:

```{r print-maps-deaths, echo=FALSE}
print(COVID.heat.map)
print(COVID.point.map)
```

***

## Mapping Active and Confirmed Cases
The rest of the code is more or less replicating what we've done above for the `confirmed` and 
`active` cases.

### Confirmed Cases
```{r map-confirmed}
#Now for confirmed cases
subset.c<-covid.OR[,c('confirmed','latitude', 'longitude', 'period')]
subset.expanded.c <- subset.c[rep(1:nrow(subset.c), subset.c$confirmed)]
subset.summary.c<- subset.c[,.(confirmed=max(confirmed)), by=c('period','latitude', 'longitude')]

## Plot a heat map layer: Polygons with fill colors based on
## relative frequency of events which we created by replicating rows by the number of events.
confirmed.heat.map <- p + 
  stat_density2d(data=subset.expanded.c, aes(x=longitude, y=latitude, fill=..level.., 
                                             alpha=..level..), geom="polygon") +
  scale_fill_gradientn(colours=brewer.pal(7, "Reds")) +
  theme(legend.position = 'none') +
  ggtitle("Oregon Confirmed Covid-19 Cases: Heat Map") +
  facet_wrap(~period)

print(confirmed.heat.map)

confirmed.point.map <-p +
  geom_point(data=subset.summary.c, aes(x=longitude, y=latitude, size=confirmed, color=confirmed),
             alpha = 0.7)+
  scale_color_gradientn(colours=brewer.pal(7, "Reds")) +
  ggtitle("Oregon Confirmed Covid-19 Cases: Heat Map") +
  facet_wrap(~period)
print(confirmed.point.map)
# Plot both maps next to each other and compare using the gridExtra package
# confirmed <- grid.arrange(confirmed.heat.map, confirmed.point.map, ncol = 2)
```

```{r print-maps-confirmed, echo=FALSE}
print(confirmed.heat.map)
print(confirmed.point.map)
```

### Active Cases
```{r map-active}
#Now for active cases
subset.a<-covid.OR[,c('active','latitude', 'longitude', 'period')]
subset.expanded.a <- subset.a[rep(1:nrow(subset.a), subset.a$active)]
subset.summary.a<- subset.a[,.(active=max(active)), by=c('period','latitude', 'longitude')]

## Plot a heat map layer: Polygons with fill colors based on
## relative frequency of events which we created by replicating rows by the number of events.
active.heat.map <- p + 
  stat_density2d(data=subset.expanded.a, aes(x=longitude, y=latitude, fill=..level.., 
                                             alpha=..level..), geom="polygon") +
  scale_fill_gradientn(colours=brewer.pal(7, "Reds")) +
  theme(legend.position = 'none') +
  ggtitle("Oregon Active Covid-19 Cases: Heat Map") +
  facet_wrap(~period)

print(active.heat.map)

active.point.map <-p +
  geom_point(data=subset.summary.a, aes(x=longitude, y=latitude, size=active, color=active),
             alpha = 0.7)+
  scale_color_gradientn(colours=brewer.pal(7, "Reds")) +
  ggtitle("Oregon Active Covid-19 Cases: Heat Map") +
  facet_wrap(~period)
print(active.point.map)
# Plot both maps next to each other and compare using the gridExtra package
# active <- grid.arrange(active.heat.map, active.point.map, ncol = 2)

# Redo the last one and adjust periods so your maps aren't scrunchie
active.point.map <-p +
  geom_point(data=subset.summary.a[subset.summary.a$period %in% c('April 10-19', 'April 20-31'),], 
             aes(x=longitude, y=latitude, size=active, color=active),alpha = 0.7)+
  scale_color_gradientn(colours=brewer.pal(7, "Reds")) +
  ggtitle("Oregon Active Covid-19 Cases: Heat Map") +
  facet_wrap(~period)
print(active.point.map)

# Plot both maps next to each other and compare using the gridExtra package
# active <- grid.arrange(active.heat.map, active.point.map, ncol = 2)

```

```{r print-maps-active, echo=FALSE}
print(active.heat.map)
print(active.point.map)
```

***

This last bit of code wraps all the plots into a tidy little image file that you can email to your
parents or S.O. to show them all the sweet GIS and coding skills you now have!
```{r plot-everything, eval=FALSE}
#Plot all maps together :)
all_maps <- grid.arrange(deaths, confirmed, active, nrow = 3)
ggsave(plot=all_maps, file.path(git.path,'covid_maps.jpeg'), height = 11, width = 10)
```

***

## Further Reading
* [**Spatial heat mapping using R**](https://trucvietle.me/r/tutorial/2017/01/18/spatial-heat-map-plotting-using-r.html )
* [**Date formats in R**](https://www.r-bloggers.com/date-formats-in-r/)
* [**US State maps using map_data()**](https://www.r-bloggers.com/us-state-maps-using-map_data/)
* [**Kelsey's favorite data.table manipulation source**](http://blog.yhat.com/posts/fast-summary-statistics-with-data-dot-table.html)