---
title: "Mapping COVID-19 Cases in Oregon"
author: "Zach"
date: "2020-04-27"
output: html_document
---



<div id="session-overview" class="section level2">
<h2>Session Overview</h2>
<p>This week, Kelsey spent some time mapping the COVID-19 cases in Oregon and generated some plots for
us. She already has provided some most illustrative documentation for her code, so I will simply
attempt to augment what she has already done.</p>
<p>In this post, we will be covering the following subjects:</p>
<ul>
<li>Subsetting the full dataset to obtain only the Oregon cases</li>
<li>Dividing the Oregon data into 10-day intervals for analysis</li>
<li>Generating a 2-dimensional density plot (heatmap) of the confirmed cases in Oregon</li>
</ul>
<p>As always, if you’d like to download the code and run it yourself, <a href="https://github.com/H4estu/COVID19-Data-Exploration/blob/master/scripts/R/session3/covid_heat_map.R"><strong>check it out on github</strong></a>.
I have edited out a few things in this post for clarity, so again, check out the link above to see
the script in its full glory.</p>
<hr />
</div>
<div id="setting-up-the-environment" class="section level2">
<h2>Setting Up the Environment</h2>
<p>First of all, we need to set up the environment in which we will be conducting our computations and
analysis. This includes importing the appropriate libraries and connecting to the database to pull
in the COVID-19 data. I have moved the code that connects to the database to a separate file and
wrapped it in a function call so that sensitive information such as the database username and
password are protected. Contact me if you need help setting up your own database configuration
script. Finally, recall that if you want to run this code, <em>you must be connected to the VPN</em>, as
the database lives on Kyle’s work machine and is only accessible via the office network.</p>
<pre class="r"><code>library(data.table)
library(magrittr)
library(dplyr)
library(ggplot2)
library(stringr)
library(RPostgreSQL)
library(maps)
library(RColorBrewer)
library(gridExtra)


git.path &lt;- Sys.getenv(&#39;HOME&#39;)  # Where the base COVID19-Data-Exploration folder lives.

# -------- Access the COVID-19 Database --------- #
source(file.path(git.path,&#39;Code/config_files/db_config.R&#39;))
con &lt;- db_connect.fn()
full.dt&lt;-dbGetQuery(con,&#39;SELECT * FROM covid_data.report_data&#39;) %&gt;% data.table
dbDisconnect(con)  
# ----------------------------------------------- #</code></pre>
<hr />
</div>
<div id="subsetting-the-data" class="section level2">
<h2>Subsetting the data</h2>
<p>To orient ourselves to the data, let’s first look at the number of cases in Oregon. Here we
are just looking at data since 01 March, because the data seem more consistently documented
since that date.</p>
<pre class="r"><code>### Summary of Oregon cases using the same method that Zach presented in the first class ###
oregon_cases.dt &lt;- full.dt[which((grepl(&#39;, OR&#39;, full.dt$province_state) | 
                                    full.dt$province_state ==&#39;Oregon&#39;
                                  ) &amp; !is.na(full.dt$latitude)
                                 ), ] %&gt;%
  group_by(last_update) %&gt;%
  summarize(Recovered=max(recovered), 
            Deaths=max(deaths), 
            Confirmed=max(confirmed), 
            Active=max(active)
  ) %&gt;% data.table

melted.dt &lt;- melt(oregon_cases.dt, id.vars=&#39;last_update&#39;, variable.name = &#39;Cases&#39;, 
                  value.name=&#39;Number.Reported&#39;)
ggplot(melted.dt, aes(x=last_update, y=Number.Reported, color=Cases)) +
  geom_point() + 
  geom_line()</code></pre>
<p><img src="/post/session3/mapping-oregon-cases_files/figure-html/first-look-1.png" width="672" /></p>
<p>What are some interesting trends that you see? Personally I find it interesting that no one appears
to be reporting <strong>recovered</strong> cases (pink line). Perhaps they are trying to capture that metric by
reporting the number of <strong>active</strong> cases (purple line)?</p>
<p>Now we are going to make a map of Oregon and plot on top of it the spatial distribution of COVID-19
cases.</p>
<pre class="r"><code>### Subset data down to only Oregon data ###
# Look at unique values for Oregon province_state, we had a change in reporting so we are going to 
# only use the data from the update onwards.
# print(full.dt[which((grepl(&#39;, OR&#39;, full.dt$province_state) | full.dt$province_state ==&#39;Oregon&#39;) &amp; 
#                       !is.na(full.dt$latitude)
#                     ), ]$province_state %&gt;% unique
     # )
covid.OR&lt;-full.dt[which(full.dt$province_state ==&#39;Oregon&#39; &amp;  !is.na(full.dt$latitude) &amp; 
                          !is.na(full.dt$admin2)
                        ), ]

# Look at the data split by date to determine how to work with it #
# covid.OR %&gt;% split(.,.$last_update) %&gt;% .[c(1,2)]

# Add new fields and make the date pretty for plotting
covid.OR$month&lt;-covid.OR$last_update %&gt;% format(., &quot;%B&quot;)

# Separate each month into &#39;periods&#39; for analysis over time. (I don&#39;t know why I didn&#39;t do weeks lol)
covid.OR$period&lt;-&quot;NA&quot;
covid.OR[covid.OR$last_update %&gt;% format(., &quot;%d&quot;) %in% paste0(&#39;0&#39;,1:9),]$period&lt;-paste0(covid.OR[covid.OR$last_update %&gt;% format(., &quot;%d&quot;) %in% paste0(&#39;0&#39;,1:9),]$month,&#39; 1-9&#39;)
covid.OR[covid.OR$last_update %&gt;% format(., &quot;%d&quot;) %in% 10:19,]$period&lt;-paste0(covid.OR[covid.OR$last_update %&gt;% format(., &quot;%d&quot;) %in% 10:19,]$month,&#39; 10-19&#39;)
covid.OR[covid.OR$last_update %&gt;% format(., &quot;%d&quot;) %in% 20:31,]$period&lt;-paste0(covid.OR[covid.OR$last_update %&gt;% format(., &quot;%d&quot;) %in% 20:31,]$month,&#39; 20-31&#39;)

# Create factor levels for ggplot facet wrap
covid.OR$period&lt;-covid.OR$period %&gt;% factor(levels = unique(.))

# Look at only deaths firsts, so subset out only that data
subset&lt;-covid.OR[,c(&#39;deaths&#39;,&#39;latitude&#39;, &#39;longitude&#39;, &#39;period&#39;)]

# The function we will be using to create our heat map requires that each value be a unique &#39;event&#39; with its own coordinate location
# rather than being able to weight the points by a particular value, because of this we must replicate our rows and their lat/long
# data by the number of the parameter of interest.
subset.expanded &lt;- subset[rep(1:nrow(subset), subset$deaths)]
# Check out the results
tail(subset.expanded, 20)</code></pre>
<pre><code>##     deaths latitude longitude      period
##  1:     37 45.54748 -122.4169 April 20-31
##  2:      1 44.90323 -123.4129 April 20-31
##  3:      2 45.16293 -121.1671 April 20-31
##  4:      2 45.16293 -121.1671 April 20-31
##  5:     10 45.55973 -123.0955 April 20-31
##  6:     10 45.55973 -123.0955 April 20-31
##  7:     10 45.55973 -123.0955 April 20-31
##  8:     10 45.55973 -123.0955 April 20-31
##  9:     10 45.55973 -123.0955 April 20-31
## 10:     10 45.55973 -123.0955 April 20-31
## 11:     10 45.55973 -123.0955 April 20-31
## 12:     10 45.55973 -123.0955 April 20-31
## 13:     10 45.55973 -123.0955 April 20-31
## 14:     10 45.55973 -123.0955 April 20-31
## 15:      6 45.23330 -123.3087 April 20-31
## 16:      6 45.23330 -123.3087 April 20-31
## 17:      6 45.23330 -123.3087 April 20-31
## 18:      6 45.23330 -123.3087 April 20-31
## 19:      6 45.23330 -123.3087 April 20-31
## 20:      6 45.23330 -123.3087 April 20-31</code></pre>
<pre class="r"><code># Next we are going to summarize our data for the point based heat map that we are going to do.
subset.summary&lt;- subset[,.(deaths=max(deaths)), by=c(&#39;period&#39;,&#39;latitude&#39;, &#39;longitude&#39;)]
print(subset.summary)</code></pre>
<pre><code>##           period latitude longitude deaths
##   1: March 20-31 45.55973 -123.0955      3
##   2: March 20-31 44.90288 -122.5815      3
##   3: March 20-31 45.54748 -122.4169      2
##   4: March 20-31 44.48899 -122.5373      2
##   5: March 20-31 45.18787 -122.2180      3
##  ---                                      
## 123: April 20-31 45.30915 -118.0069      0
## 124: April 20-31 45.57894 -117.1835      0
## 125: April 20-31 45.16293 -121.1671      2
## 126: April 20-31 45.55973 -123.0955     10
## 127: April 20-31 45.23330 -123.3087      6</code></pre>
<pre class="r"><code># Generate a map of Oregon to plot the COVID data on using &#39;maps&#39; package
all_states&lt;-map_data(&#39;state&#39;)
head(all_states)</code></pre>
<pre><code>##        long      lat group order  region subregion
## 1 -87.46201 30.38968     1     1 alabama      &lt;NA&gt;
## 2 -87.48493 30.37249     1     2 alabama      &lt;NA&gt;
## 3 -87.52503 30.37249     1     3 alabama      &lt;NA&gt;
## 4 -87.53076 30.33239     1     4 alabama      &lt;NA&gt;
## 5 -87.57087 30.32665     1     5 alabama      &lt;NA&gt;
## 6 -87.58806 30.32665     1     6 alabama      &lt;NA&gt;</code></pre>
<pre class="r"><code>Oregon&lt;-all_states[all_states$region==&#39;oregon&#39;,]
p &lt;- ggplot() +
  geom_polygon(data=Oregon, aes(x=long, y=lat))
print(p)</code></pre>
<p><img src="/post/session3/mapping-oregon-cases_files/figure-html/subset-data-1.png" width="672" /></p>
<pre class="r"><code>## Plot a heat map layer: Polygons with fill colors based on
## relative frequency of events
COVID.map &lt;- p + stat_density2d(data=subset.expanded, aes(x=longitude, y=latitude, fill=..level.., alpha=..level..), geom=&quot;polygon&quot;)
print(COVID.map)</code></pre>
<p><img src="/post/session3/mapping-oregon-cases_files/figure-html/subset-data-2.png" width="672" /></p>
<hr />
</div>
<div id="further-reading" class="section level2">
<h2>Further Reading</h2>
<ul>
<li><a href="https://trucvietle.me/r/tutorial/2017/01/18/spatial-heat-map-plotting-using-r.html"><strong>Spatial heat mapping using R</strong></a></li>
<li><a href="https://www.r-bloggers.com/date-formats-in-r/"><strong>Date formats in R</strong></a></li>
<li><a href="https://www.r-bloggers.com/us-state-maps-using-map_data/"><strong>US State maps using map_data()</strong></a></li>
<li><a href="http://blog.yhat.com/posts/fast-summary-statistics-with-data-dot-table.html"><strong>Kelsey’s favorite data.table manipulation source</strong></a></li>
</ul>
</div>
